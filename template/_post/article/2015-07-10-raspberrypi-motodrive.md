---
layout: post
title: 树莓派之电机驱动
category: 学习笔记
description: 制作做机器人的第一步
tags: 编程 树莓派
---
![raspberrypi](/static/blog/img/project/20150710/2015071000.jpg)

　　树莓派拥有一组用户定义的GPIO，通过它可以收集传感器数据、驱动电机等等，各种异想天开的小发明少了它都无法实现。下面简单分析一下如何用树莓派的GPIO来驱动直流电机。
<!--more-->
　　我记得在很小的时候，老爸给我买了一个播放磁带的单放机，那机器里面就有一个小电机驱动磁带、播放声音。但是那个时候的单放机都没有稳压电路，新买的电池插到机器里，磁带就转的很快，放出来的声音声调偏高。如果电池快没电了，磁带就转的很慢，播放出来的音乐声调又非常的低沉。如果粗心大意，将电池装反，那悲剧发生了：磁带反转，甚至会卡在机器里……

　　虽然现在很难买到磁带机了，但通过这种现象可以总结出直流电机的两个特性，一是驱动电压越高，转速越快；二是驱动电压的极性如果调换，那电机旋转的方向也会逆转过来。

　　树莓派驱动电机，是将树莓派的GPIO输出的信号放大后，加载到直流电机的两个输入端。树莓派的IO口可以单独输出高低电平，也就是正负电压，所以控制直流电机的正反转是相对容易的。但却无法让GPIO输出介于0V到3.3V之间的电压，所以不采取某些特殊措施的话，电机要么只能停住，要么就只能全速运行，很难实现调速。

　　所谓特殊的措施，就是使用“脉冲宽度调制(Pulse Width Modulation,PWM)”技术来产生驱动信号。简单理解，就是使用一定占空比的方波信号来驱动电机，由于其频率较高，所以从宏观上看信号的有效电压值与占空比成一定关系：占空比越高，则等效的电压越高，当占空比为100%时，输出的电压为VCC，也就是3.3V。如图，蓝色为PWM信号，红色为等效的模拟信号。在误差可以接受的情况下，使用下面两种信号放大后来驱动电机，效果几乎是相同的。

![raspberrypi](/static/blog/img//project/20150710/2015071002.jpg)

　　不过可惜的是，官方阉割了第二代的树莓派的PWM功能，所以控制电机只能使用软件模拟产生PWM的方法，或者使用额外的控制器来协助控制电机。弄清了树莓派控制电机的原理，重点是如何搭建驱动电路，也就是放大树莓派IO引脚的信号的模块。虽然市面上可以买到各种直流电机的驱动模块，它们的核心是集成电机驱动芯片，使用方便，但它们并不能满足所有的需求，一来它们的售价比较昂贵，二来在不同的情况下，我们需要定制不同规模的驱动电路，小马拉大车或者大马拉小车总是不合适的。

##最简单的电机驱动
　　把它归结为第一类驱动，它的特点是：只能实现调速而不能改变电机转向，没有刹车功能。

![raspberrypi](/static/blog/img//project/20150710/2015071003.png)

　　此电机驱动的核心在于下方的MOS管。这里的MOS管为增强型N MOS管，它有三个电极，上方的为漏极D，左侧为栅极G，下方为源极S。不同型号的MOS管有不同的阈值电压，即栅极-源极电压，VGS。在实际电路中，栅极上的电压大于VGS的时候，MOS管导通，电流经过漏极、源极产生通路，电机开始转动。如果栅极电压低于VGS，则MOS管截止，整个电路不导通，电机失去动力。所以，只要PWM信号的高电平大于VGS，低电平小于VGS，则可以直接作为栅极的驱动信号来控制MOS管的导通与关断。

##实现刹车
　　其实只需要很少的改变就可以实现刹车功能。刹车就是使电机抱死、锁死，不允许它运转。如果采用第一种电机驱动，PWM信号处于低电平期间电机虽然失去动力，但依靠惯性仍然会继续转动。可以看到，电机一端固定至VCC，另一端却是悬空的。如果将悬空的引脚也接到VCC，则在电机的线圈间形成回路，电机依靠惯性转动时产生的反电动势会加载到自身，使电机产生反向转动的趋势，从而实现刹车。第二类的驱动可如下设计：

![raspberrypi](/static/blog/img//project/20150710/2015071004.png)

　　这里增加了一个PMOS管。PMOS管倒着放置在电路图中，上方是源极S，下方是漏极D，左侧为栅极G。与NMOS不同的是，PMOS管的源极接入高电平，阈值电压VGS为负值，栅极与源极的电压差（栅-源电压）也为负值。当栅-源电压的绝对值大于阈值电压VGS的绝对值时，MOS管导通；小于VGS的绝对值时，MOS管截止。因此，输入的PWM信号为高电平时，上方的PMOS截止，下方的NMOS导通，电机左侧电平为低，右侧为高，开始运转；当PWM信号为低时，上方的PMOS导通，下方的NMOS截止，电机两侧都为高电平，因此刹车。

　　但事实上，上面的电机驱动电路有着致命的危险和安全隐患。危险发生在下面两种情况之一：其一是PWM信号的高电平电压与电机驱动电压VCC相差较大，其二是PWM信号频率过高，这两种情况都会严重烧毁电路。第一点是因为，如果PWM信号的高电平电压，比电机驱动电压VCC减掉PMOS的阈值电压VGS的绝对值还要低，那么即使PWM为高电平，上方的PMOS管栅-源电压绝对值依然大于阈值电压VGS的绝对值，此时PMOS管无法关断，而下方的NMOS已经导通。所以，两个MOS管同时导通，强大的电流经过两个MOS管而造成短路，这是不允许的。其二是因为，NMOS和PMOS的制作工艺不同，MOS管切换关断或导通的状态需要一定的时间（通常为几十至几百纳秒）。当PWM信号由低电平跳变到高电平，有可能造成NMOS还没来得及关断而PMOS已经导通，或者PMOS还没来得及关断而NMOS已经导通的情况，此时强大的电流也会流过两个MOS管。但如果PWM信号频率较低，这种电流冲击频率也低，不会对电路造成严重损害，但PWM信号频率较高的话，两个MOS管就会反复遭受大电流冲击，因此将造成短路而引发事故。

　　因此，改进型的驱动如下：

![raspberrypi](/static/blog/img//project/20150710/2015071005.png)

　　使用两路独立的PWM信号来控制左侧的半桥。注意到两路PWM信号的差别，当上方的PWM信号跳变为高电平时，PMOS截止，短暂的延时之后，下方的PWM信号才跳变到高电平，使下方的NMOS导通。同样在反过程中，也用类似的方法确保了其中一个MOS管有足够的时间关断，避免了电平的冲突。两路PWM信号相差的部分，被称之为死区。死区的的选取较为重要，若死区时间较短，则不能避免电平冲突，若时间较长，就会影响PWM信号的精确度。

　　上面的电机驱动解决了MOS管不能同时关断、同时导通的问题，但仍然不能解决另外一个问题，那就是PWM信号的电平匹配问题。前面分析过，如果PWM信号高电平低于电机驱动电压VCC减去PMOS管的阈值电压VGS的绝对值，那不管PWM信号为高电平还是低电平，PMOS管都将无法关断。想要解决这个问题其实并不难，只要将PMOS也替换为NMOS，同时将PMOS对应的PWM信号翻转即可。

![raspberrypi](/static/blog/img//project/20150710/2015071006.png)

　　由于驱动电路中全部是NMOS管，只要PWM信号低电平小于VGS，高电平大于VGS，就不再有MOS管无法关断的问题。现在已经完美的解决了上述的两个问题。但付出的代价是，多使用了一路PWM波。这对于树莓派是致命的，因为二代的树莓派没有硬件PWM发生器，即使是一代的树莓派，也只有1路PWM输出。所以要输出两路互补带死区的PWM信号，必须借助其他的控制器了。笔者在这里强烈推荐德州仪器的MSP430系列微控制器，在多路PWM输出方面功能强大，配置起来也十分灵活。下面是MSP430数据手册中将其配置为“互补的带死区PWM输出模式”的部分截图：

![raspberrypi](/static/blog/img//project/20150710/2015071007.png)

##全H桥电机驱动
　　有了的基础，想要理解全H桥电机驱动就容易多了。只需要将左边的半桥复制到右侧，这样整个电路如同一个“H”形，因此也被称为H桥。这样就可以实现刹车、调速、正反转的功能。

![raspberrypi](/static/blog/img//project/20150710/2015071008.png)

　　此时电机驱动就完美了，但为了保护微控制器的输出端口，常常使用光电耦合器来隔离强电和弱电区。光耦的使用方法较为简单，这里不再赘述。

　　在广泛使用的各种集成电机驱动芯片中，H桥为基本构成部分，绝大多数直流电机驱动都建立在“H”桥的基础之上。而且“H”桥电路不仅仅用于电机的驱动，还常用于直流-交流变换的电路当中，这里仅仅对最基本的工作原理作出浅析。总之，它是一种应用非常广泛的电路，非常值得深入探究。