---
title: PostgreSQL的索引与事务
category: 学习笔记
tag: MySQL, PostgreSQL
---

## 索引
　　索引是数据库中一种快速查询数据的方法。索引中记录了表中一列或多列的值与其物理位置之间的对应关系。

　　索引本身也是数据库中读写均衡的一个体现，一般来讲，__建立索引能够加快对数据表中的记录的查找和排序，但它同时也拖慢了写入和更新数据的操作，因为此时也需要对索引作相应的更新__。此外，建立索引也会额外增加数据库的存储空间。

## 索引的种类

　　PG支持以下几种索引：

* B-tree：常用。适合处理等值查询和范围查询。
* Hash：只能处理简单的等值查询。
* GiST：一种架构，在此之上可以实现多种不同的索引策略。它定义的特定的操作符（如一个图形包含另一个图形的“@>”）使用特定的索引策略。
* SP-GiST：从9.2版本引入，提供了一种新索引类型，通过一些新的索引算法提高GiST在某个情况下的性能。
* GIN：翻转索引，可以处理包含多个键的值，如数组等。

　　通常在创建索引的时候，PG会锁定表防止写入，然后对全表扫描以完成索引建立。如果此表过大，或更新频繁，则可能阻塞操作导致结果不能接受。所以此时可以并发创建索引。

　　通过在CREATE INDEX命令中添加CONCURRENTLY参数，告知PG创建索引采用并发创建索引方式。此时PG会执行两次全表扫描，因此需要更长的时间，但此时不会长时间阻塞写入。

　　并发创建索引时，如果在过程中被取消，可能会留下一个“INVALID”索引，这会导致更新变慢；若此索引为唯一索引，还可能导致插入重复值造成更新失败。此时，只需要删除掉INVALID索引即可。

## 事务

　　数据库的ACID性质让开发人员的工作得到最大限度的简化。其中ACID分别为原子性、一致性、隔离性、持久性，具体如下：

* 原子性：对于数据的修改，多个插入或更新要么全部成功，要么全部失败，并在失败后可以回滚到之前的状态
* 一致性：事务完成之后所有数据保持一致的状态
* 隔离性：事务查看数据的状态，要么是操作之前的状态，要么是更新之后的状态，不查看中间状态
* 持久性：事务完成之后，对系统的影响是永久性的，即使发生断电等故障，数据也一直保持

　　在PG中，采用多版本并发控制（MVCC）来维护数据的一致性，主要优点是在MVCC中对读数据的锁请求和写数据的锁请求不冲突，即读不会阻塞写，写也不会阻塞读。PG中提供了表和行级别的锁定语句，让应用能够方便的操作并发数据。

　　PG中大多数DDL可以包含在一个事务中，而且是可以回滚的。所以PG非常合适被用在Sharding的分布式系统底层数据库。譬如有时需要在多个节点建立相同的表，这时可以考虑把建表语句放在同一个事务当中，这样可以在各个节点中先启动一个事务，然后执行建表语句。如果某个节点建立失败，则可以回滚操作，也就不会出现部分节点建表成功，而部分节点建表失败的情况。
